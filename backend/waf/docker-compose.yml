# taken from : https://github.com/coreruleset/modsecurity-crs-docker/blob/main/docker-compose.yaml

x-defaults: &default-settings
  environment:
    SERVERNAME: localhost
    #############################################
    # CRS Variables
    #############################################
    # Paranoia Level
    PARANOIA: 1
    # Replaces PARANOIA as of CRS 4
    BLOCKING_PARANOIA: 1
    # Inbound and Outbound Anomaly Score Threshold
    ANOMALY_INBOUND: 5
    ANOMALY_OUTBOUND: 4
    # Executing Paranoia Level
    # - EXECUTING_PARANOIA=2
    #
    # Replaces EXECUTING_PARANOIA as of CRS 4
    # - DETECTION_PARANOIA=2
    #
    # New in CRS 4
    # default configurations
    ENFORCE_BODYPROC_URLENCODED: 1
    ALLOWED_METHODS: GET HEAD POST OPTIONS
    ALLOWED_REQUEST_CONTENT_TYPE: "|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|"
    ALLOWED_REQUEST_CONTENT_TYPE_CHARSET: "utf-8|iso-8859-1|iso-8859-15|windows-1252"
    ALLOWED_HTTP_VERSIONS: HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0
    RESTRICTED_EXTENSIONS: .asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .rdb/ .resources/ .resx/ .sql/ .swp/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/
    RESTRICTED_HEADERS_BASIC: /content-encoding/ /proxy/ /lock-token/ /content-range/ /if/ /x-http-method-override/ /x-http-method/ /x-method-override/
    RESTRICTED_HEADERS_EXTENDED: /accept-charset/
    STATIC_EXTENSIONS: /.jpg/ /.jpeg/ /.png/ /.gif/ /.js/ /.css/ /.ico/ /.svg/ /.webp/\

    MAX_NUM_ARGS: 255
    ARG_NAME_LENGTH: 100
    ARG_LENGTH: 400
    TOTAL_ARG_LENGTH: 64000
    MAX_FILE_SIZE: 1048576
    COMBINED_FILE_SIZES: 1048576

    # CHANGE to backend
    BACKEND: "http://localhost:8081" # change to fastify app
    REPORTING_LEVEL: 2

    SEC_RULE_ENGINE: "On" # Turn on ModSecurity
    SEC_DEFAULT_ACTION: "phase:1,log,auditlog,deny,status:403"

  volumes:
    - ./rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
    - ./rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf:/etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf

services:
  # change to waf later on
  crs-apache:
    image: owasp/modsecurity-crs:apache
    container_name: waf
    ports:
      - "8080:8080"
      # - "80:8080"
      # only available if SETTLS was enabled:
      # - "443:8443"
    <<: *default-settings
